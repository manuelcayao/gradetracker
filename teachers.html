<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EZ Grade Tracker — PCCAES</title>

<!-- SheetJS for Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#2b6cb0; --accent:#16a34a; --danger:#dc2626; --muted:#6b7280;
  --light-green: #e6ffef;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f3f6fb;color:#111}
header{background:var(--primary);color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
header h1{margin:0;font-size:18px}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.layout{display:flex;gap:20px;align-items:flex-start}
.article{flex:1;background:#fff;padding:18px;border-radius:8px;border:1px solid #e8eef8}
.login-box{width:360px;background:#fff;padding:18px;border-radius:8px;border:1px solid #e8eef8}
.login-box-improved{background:linear-gradient(0deg,#ffffff,#f8fafc); padding:18px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06);}
h2{margin:0 0 12px 0}
p.small{color:var(--muted);font-size:13px}
label{display:block;margin-top:8px;font-weight:600;font-size:13px}
input,select,button,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #dfe7f3;margin-top:6px;font-size:14px}
button{cursor:pointer}
.btn-primary{background:var(--primary);color:#fff;border:none;padding:8px 10px;border-radius:6px}
.btn-success{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px}
.btn-danger{background:var(--danger);color:#fff;border:none;padding:8px 10px;border-radius:6px}
.btn-outline{background:#fff;color:var(--primary);border:1px solid var(--primary);padding:8px;border-radius:6px}
.btn-warning{background:#f59e0b;color:white;border:none;padding:8px;border-radius:6px}
.small{font-size:13px;color:var(--muted)}
.page{display:none;margin-top:12px}
.page.active{display:block}
.card{background:#fff;border:1px solid #e8eef8;padding:12px;border-radius:8px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border:1px solid #e6eef8;padding:8px;text-align:center;font-size:13px}
.table th{background:#eef6ff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999}
.modal .modal-content{width:96%;max-width:980px;background:#fff;padding:16px;border-radius:8px;max-height:90vh;overflow:auto}
.close{float:right;cursor:pointer;color:#333;font-weight:700}
.loading{display:none;text-align:center;margin:12px 0}
@media (max-width:1200px){ .container{padding:0 12px} }
@media (max-width:900px){.layout{flex-direction:column}.login-box{width:100%}.modal .modal-content{width:95%}}
.role-grid { display:flex; flex-wrap:wrap; gap:8px; }
.role-grid button { padding:8px; border-radius:6px; border:1px solid #dfe7f3; background:#fff; cursor:pointer; }
.admin-btn-small { padding:6px 8px; font-size:13px; border-radius:6px; }
.green-article { background: var(--light-green); padding:16px; border-radius:8px; text-align:center; }
.controls-top { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.dec-btn { padding:6px 8px; border-radius:6px; }
.muted-note { color:var(--muted); font-size:13px; margin-top:6px; }
.file-input-hidden { display:none }
.feedback { font-size:13px; color:var(--muted); margin-top:6px; }
.success { color: green; }
.error { color: var(--danger); }
.filter-section { display: flex; gap: 8px; align-items: center; }
.filter-section input { width: 150px; }
.forgot-password { text-align: right; margin-top: 8px; }
.forgot-password a { color: var(--primary); text-decoration: none; font-size: 13px; }
.forgot-password a:hover { text-decoration: underline; }
.firebase-status { padding: 8px; margin: 10px 0; border-radius: 6px; font-size: 13px; text-align: center; }
.firebase-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.firebase-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.config-setup { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin: 10px 0; }
.login-message { padding: 10px; margin: 10px 0; border-radius: 6px; text-align: center; }
.login-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.login-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px; color: white; font-weight: bold; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out; }
.notification.success { background: var(--accent); }
.notification.error { background: var(--danger); }
.notification.info { background: var(--primary); }
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.user-info { display: flex; align-items: center; gap: 10px; margin-left: auto; }
.user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.user-name { font-size: 14px; }
.activity-log { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid var(--primary); }
.activity-item { padding: 5px 0; border-bottom: 1px solid #e9ecef; }
.activity-item:last-child { border-bottom: none; }
.activity-time { font-size: 11px; color: var(--muted); }
/* Print Styles */
@media print {
    body * {
        visibility: hidden;
    }
    #printableReportCard, #printableReportCard * {
        visibility: visible;
    }
    #printableReportCard {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
    }
    .no-print {
        display: none !important;
    }
    .print-table {
        width: 100%;
        border-collapse: collapse;
    }
    .print-table th, .print-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: center;
    }
    .print-table th {
        background-color: #f0f0f0;
    }
}
.account-management { margin-top: 20px; }
.account-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
.account-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.account-actions { display: flex; gap: 8px; }
.account-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
</style>
</head>
<body>

<!-- Firebase Setup Instructions -->
<div id="firebaseSetup" class="config-setup">
    <h3>🚀 Firebase Setup Required</h3>
    <p><strong>Step 1:</strong> Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></p>
    <p><strong>Step 2:</strong> Create a new project and enable Firestore Database</p>
    <p><strong>Step 3:</strong> Click "Web App" and copy the config</p>
    <p><strong>Step 4:</strong> Replace the Firebase config below with your actual values</p>
    <button onclick="showFirebaseConfig()">Show Current Firebase Config</button>
</div>

<!-- Firebase Status Indicator -->
<div id="firebaseStatus" class="firebase-status firebase-disconnected">
    🔴 Firebase Not Configured - Using Local Storage Only
</div>

<header>
  <h1>EZ Grade Tracker — PCCAES</h1>
  <div class="small" id="headerSubtitle">LOGIN FORM</div>
  <div class="user-info" id="userInfo" style="display:none">
    <div class="user-avatar" id="userAvatar"></div>
    <div class="user-name" id="userName"></div>
  </div>
</header>

<!-- MAIN container / landing (login area) -->
<div class="container" id="landing">
  <div class="layout">
    <div style="flex:1">
      <div class="article">
        <h2>Welcome to EZ Grade Tracker</h2>
        <p class="small">Teachers / admins: import students via Excel (per-grade), add/edit students manually, and print report cards. Students create their own account using LRN + password and can view their report card. Admins manage teacher/admin accounts and exports.</p>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div class="card" style="flex:2">
            <h3>Quick Features</h3>
            <ul class="small">
              <li>Per-grade dashboards (SPED/Kinder/Grade 1–6)</li>
              <li>Add / import / export / edit / delete students</li>
              <li>Report card generation</li>
              <li>Data synchronized with Firebase (works across devices)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Login box -->
    <aside class="login-box login-box-improved">
      <h2 style="margin-top:0">Login / Create Account</h2>

      <label>Role</label>
      <select id="roleSelect" onchange="onRoleChange()">
        <option value="student">Student</option>
        <option value="admin">Admin</option>
        <option value="teacher">Teacher</option>
        <option value="sped">SPED Teacher</option>
        <option value="kinder">Kinder Teacher</option>
        <option value="1">Grade 1 Teacher</option>
        <option value="2">Grade 2 Teacher</option>
        <option value="3">Grade 3 Teacher</option>
        <option value="4">Grade 4 Teacher</option>
        <option value="5">Grade 5 Teacher</option>
        <option value="6">Grade 6 Teacher</option>
      </select>

      <!-- Student login -->
      <div id="studentLoginBlock" style="margin-top:8px">
        <label>LRN (12 digits)</label>
        <input id="studentLoginLRN" placeholder="Enter 12-digit LRN">
        <label>Password</label>
        <input id="studentLoginPass" type="password" placeholder="Enter password">
        <div class="forgot-password">
          <a href="#" onclick="showForgotPasswordModal(); return false;">Forgot Password?</a>
        </div>
      </div>

      <!-- Email login for admin/teacher -->
      <div id="emailLoginBlock" style="display:none;margin-top:8px">
        <label>Email (for Admin / Teacher)</label>
        <input id="emailLogin" placeholder="name@depedqc.ph">
        <label>Password</label>
        <input id="emailLoginPass" type="password" placeholder="Enter password">
        <div class="muted-note">Teachers: use your account created by an Admin.</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn-primary" id="btnLogin" onclick="handleLogin()">Login</button>
      </div>

      <div id="loginMessage" class="login-message" style="display:none;"></div>

      <hr style="margin:12px 0">

      <h3 style="margin:0 0 8px 0">Create Student Account</h3>
      <p class="small">Students: create account with LRN + password. Your LRN must already exist in student records.</p>
      <label>LRN (12 digits)</label>
      <input id="createLRN" placeholder="Enter 12-digit LRN">
      <label>Password</label>
      <input id="createPass" type="password" placeholder="Choose a password">
      <label>Confirm Password</label>
      <input id="createPass2" type="password" placeholder="Confirm password">
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-success" id="btnCreateStudent" onclick="handleCreateStudentAccount()">Create Account</button>
        <button class="btn-outline" id="btnClearCreate" onclick="clearCreateForm()">Clear</button>
      </div>
    </aside>
  </div>
</div>

<!-- STUDENT PAGE -->
<section id="page-student" class="page container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Student — Report Card</h2>
    <div style="display:flex;gap:8px">
      <button class="btn-outline" onclick="showLanding()">Home</button>
      <button class="btn-warning" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>My Report Card</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="studentSearchLRN" placeholder="Enter LRN or leave empty to view your own">
      <button class="btn-success" onclick="studentSearch()">Show</button>
      <div style="margin-left:auto">
        <button class="btn-outline" id="btnStudentPrint" onclick="printStudentReport()" style="display:none">Print Report Card</button>
      </div>
    </div>
    <div id="studentResult" style="margin-top:12px"></div>
  </div>
</section>

<!-- ADMIN PAGE -->
<section id="page-admin" class="page container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Admin Page</h2>
    <div style="display:flex;gap:8px">
      <button class="btn-outline" onclick="showLanding()">Home</button>
      <button class="btn-warning" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Create Teacher/Admin Account</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end">
      <div>
        <label>Email</label><input id="adminCreateEmail" placeholder="name@depedqc.ph">
      </div>
      <div>
        <label>Password</label><input id="adminCreatePass" type="password" placeholder="password">
      </div>

      <div>
        <label>Role</label>
        <select id="adminCreateRole">
          <option value="teacher">Teacher</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div>
        <label>Assigned Grade Level (for Teacher)</label>
        <select id="adminCreateGrade">
          <option value="">-- Select Grade --</option>
          <option value="sped">SPED</option>
          <option value="kinder">Kinder</option>
          <option value="1">Grade 1</option>
          <option value="2">Grade 2</option>
          <option value="3">Grade 3</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
        </select>
      </div>

      <div style="display:flex;align-items:end">
        <button class="btn-success admin-btn-small" onclick="adminCreateAccount()">Create Account</button>
      </div>
    </div>
    <div class="feedback" id="adminCreateFeedback"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Admin Tools</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn-success admin-btn-small" onclick="exportAllCSV()">Export All Students (CSV)</button>
      <button class="btn-danger admin-btn-small" onclick="purgeAll()">Purge All Students</button>
      <button class="btn-primary admin-btn-small" onclick="showAllAccounts()">Show All Accounts</button>
      <button class="btn-outline admin-btn-small" onclick="testAccounts()">Test Accounts</button>
    </div>
  </div>

  <!-- Enhanced Account Management -->
  <div class="card" style="margin-top:12px">
    <h3>Account Management</h3>
    
    <!-- Teacher Accounts -->
    <div class="account-management">
      <h4>Teacher Accounts</h4>
      <div id="teacherAccountsList" class="small">
        Loading teacher accounts...
      </div>
    </div>

    <!-- Student Accounts -->
    <div class="account-management">
      <h4>Student Accounts</h4>
      <div id="studentAccountsList" class="small">
        Loading student accounts...
      </div>
    </div>

    <!-- Admin Accounts -->
    <div class="account-management">
      <h4>Admin Accounts</h4>
      <div id="adminAccountsList" class="small">
        Loading admin accounts...
      </div>
    </div>
  </div>

  <!-- Activity Log -->
  <div class="card" style="margin-top:12px">
    <h3>Recent Activity</h3>
    <div id="activityLog" class="activity-log">
      <div class="activity-item">
        <div>System initialized</div>
        <div class="activity-time" id="currentTime"></div>
      </div>
    </div>
  </div>
</section>

<!-- TEACHER DASHBOARD PAGE -->
<section id="page-teacher" class="page container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 id="teacherTitle">Teacher Dashboard</h2>
    <div style="display:flex;gap:8px">
      <button class="btn-outline" onclick="showLanding()">Home</button>
      <button class="btn-warning" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Welcome, <span id="teacherWelcomeName"></span>!</h3>
    <p>Assigned Grade: <strong id="teacherAssignedGrade"></strong></p>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Grade Management</h3>
    <p>Click on your assigned grade to manage students:</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
      <button class="btn-outline" onclick="openAssignedGradeDashboard('sped')" id="gradeBtnSped">SPED</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('kinder')" id="gradeBtnKinder">Kinder</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('1')" id="gradeBtn1">Grade 1</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('2')" id="gradeBtn2">Grade 2</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('3')" id="gradeBtn3">Grade 3</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('4')" id="gradeBtn4">Grade 4</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('5')" id="gradeBtn5">Grade 5</button>
      <button class="btn-outline" onclick="openAssignedGradeDashboard('6')" id="gradeBtn6">Grade 6</button>
    </div>
  </div>

  <!-- Teacher Activity Log -->
  <div class="card" style="margin-top:12px">
    <h3>My Recent Activity</h3>
    <div id="teacherActivityLog" class="activity-log">
      <div class="activity-item">
        <div>Logged in successfully</div>
        <div class="activity-time" id="teacherCurrentTime"></div>
      </div>
    </div>
  </div>
</section>

<!-- GRADE DASHBOARDS -->
<section id="page-grade" class="page container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 id="gradeTitle">Grade Dashboard</h2>
    <div style="display:flex;gap:8px">
      <button class="btn-outline" onclick="goBackToTeacher()" id="backToTeacherBtn" style="display:none">Back to Teacher Dashboard</button>
      <button class="btn-outline" onclick="showLanding()">Home</button>
      <button class="btn-warning" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="controls-top">
      <div>
        <button class="btn-success" id="btnAddStudentGrade" onclick="openAddStudentModal()">+ Add Student</button>
      </div>
      <div class="filter-section">
        <label>LRN Filter</label>
        <input id="gradeFilterLRN" placeholder="Filter by LRN" oninput="renderGradeTable()">
        <label>Section Filter</label>
        <input id="gradeFilterSection" placeholder="Filter by section" oninput="renderGradeTable()">
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button class="btn-outline" onclick="exportGrade()">Export Excel (Grade)</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
      <div>
        <label>Decimal places:</label>
        <button class="dec-btn" onclick="changeDecimal(-1)">−</button>
        <span id="decimalDisplay">2</span>
        <button class="dec-btn" onclick="changeDecimal(1)">+</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;overflow:auto">
    <table class="table" id="gradeTable">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>LRN</th><th>Grade</th><th>Section</th><th>School Year</th><th>Adviser</th>
          <th>1Q Avg</th><th>2Q Avg</th><th>3Q Avg</th><th>4Q Avg</th><th>Overall Avg</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="gradeTableBody"></tbody>
    </table>
  </div>

  <!-- Grade Management Activity Log -->
  <div class="card" style="margin-top:12px">
    <h3>Grade Management Activity</h3>
    <div id="gradeActivityLog" class="activity-log">
      <div class="activity-item">
        <div>Grade dashboard loaded</div>
        <div class="activity-time" id="gradeCurrentTime"></div>
      </div>
    </div>
  </div>
</section>

<!-- MODALS -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('studentModal')">&times;</span>
    <h3 id="studentModalTitle">Add / Edit Student</h3>
    <form id="studentForm" onsubmit="handleStudentFormSubmit(event)">
      <input type="hidden" id="edit_lrn_key" />
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>LRN</label><input id="f_lrn" required>
          <label>Last Name</label><input id="f_last">
          <label>First Name</label><input id="f_first">
          <label>Middle Name</label><input id="f_middle">
          <label>Gender</label>
          <select id="f_gender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
        <div>
          <label>Grade Level</label>
          <select id="f_grade" onchange="populateGradeInputs()">
            <option value="kinder">Kinder</option>
            <option value="sped">SPED</option>
            <option value="1">Grade 1</option>
            <option value="2">Grade 2</option>
            <option value="3">Grade 3</option>
            <option value="4">Grade 4</option>
            <option value="5">Grade 5</option>
            <option value="6">Grade 6</option>
          </select>
          <label>Section</label><input id="f_section">
          <label>School Year</label><input id="f_schoolyear" placeholder="e.g., 2025-2026">
          <label>Adviser</label><input id="f_adviser">
        </div>
      </div>

      <hr style="margin:12px 0">
      <h4>Grades (enter 1st - 4th quarter per subject; leave blank if N/A)</h4>

      <div style="overflow:auto;max-height:50vh">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>4th</th></tr></thead>
          <tbody id="gradesInputsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;">
        <button class="btn-success" type="submit">Save Student</button>
        <button type="button" class="btn-outline" onclick="closeModal('studentModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('viewModal')">&times;</span>
    <div id="viewContent"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-outline" onclick="printView()">Download as PDF</button>
      <button class="btn-primary" onclick="closeModal('viewModal')">Close</button>
    </div>
  </div>
</div>

<!-- Print Template (Hidden) -->
<div id="printableReportCard" style="display:none;"></div>

<script>
/* ===========================
   Firebase Configuration
   =========================== */
const firebaseConfig = {
    apiKey: "AIzaSyALNKdxYltRrxP706l8N6hzcL57KpV86Yg",
    authDomain: "pccaesezgrade.firebaseapp.com",
    projectId: "pccaesezgrade",
    storageBucket: "pccaesezgrade.firebasestorage.app",
    messagingSenderId: "398152029171",
    appId: "1:398152029171:web:34794dca4c14b88ce83886",
    measurementId: "G-CEKJZN098P"
};

let db = null;
let firebaseInitialized = false;

function initializeFirebase() {
    try {
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            
            document.getElementById('firebaseStatus').className = 'firebase-status firebase-connected';
            document.getElementById('firebaseStatus').innerHTML = '🟢 Firebase Connected - Data will sync across devices!';
            document.getElementById('firebaseSetup').style.display = 'none';
            
            console.log('Firebase initialized successfully');
        }
    } catch (error) {
        console.warn('Firebase initialization failed, using localStorage:', error);
    }
}

function showFirebaseConfig() {
    alert('Current Firebase Config:\n\n' + JSON.stringify(firebaseConfig, null, 2) + 
          '\n\nTo use Firebase, replace these values with your actual Firebase project configuration.');
}

/* ===========================
   Notification System
   =========================== */
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

/* ===========================
   Activity Log System
   =========================== */
function logActivity(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const activityItem = `
        <div class="activity-item">
            <div>${message}</div>
            <div class="activity-time">${timestamp}</div>
        </div>
    `;
    
    // Add to admin activity log
    const adminLog = document.getElementById('activityLog');
    if (adminLog) {
        adminLog.insertAdjacentHTML('afterbegin', activityItem);
        // Keep only last 10 activities
        const items = adminLog.querySelectorAll('.activity-item');
        if (items.length > 10) {
            items[items.length - 1].remove();
        }
    }
    
    // Add to teacher activity log if teacher is logged in
    if (currentUser && currentUser.type === 'teacher') {
        const teacherLog = document.getElementById('teacherActivityLog');
        if (teacherLog) {
            teacherLog.insertAdjacentHTML('afterbegin', activityItem);
            const items = teacherLog.querySelectorAll('.activity-item');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
        }
    }
    
    // Add to grade activity log if on grade page
    const gradeLog = document.getElementById('gradeActivityLog');
    if (gradeLog && currentGradeContext) {
        gradeLog.insertAdjacentHTML('afterbegin', activityItem);
        const items = gradeLog.querySelectorAll('.activity-item');
        if (items.length > 10) {
            items[items.length - 1].remove();
        }
    }
    
    console.log(`[ACTIVITY] ${timestamp}: ${message}`);
}

/* ===========================
   Database Functions - FIXED
   =========================== */
const STORE_STUDENTS = 'students';
const STORE_STUDENT_ACCOUNTS = 'student_accounts';
const STORE_TEACHERS = 'teachers';
const STORE_ADMINS = 'admins';

async function dbSave(storeName, key, data) {
    console.log('Saving to', storeName, 'with key:', key, 'data:', data);
    
    if (firebaseInitialized && db) {
        try {
            await db.collection(storeName).doc(key).set(data);
            localStorage.setItem(`${storeName}_${key}`, JSON.stringify(data));
            console.log('Successfully saved to Firebase');
            return true;
        } catch (error) {
            console.warn('Firebase save failed, using localStorage:', error);
        }
    }
    
    // Fallback to localStorage
    localStorage.setItem(`${storeName}_${key}`, JSON.stringify(data));
    console.log('Saved to localStorage as fallback');
    return true;
}

async function dbGet(storeName, key) {
    console.log('Getting from', storeName, 'with key:', key);
    
    if (firebaseInitialized && db) {
        try {
            const doc = await db.collection(storeName).doc(key).get();
            if (doc.exists) {
                const data = doc.data();
                localStorage.setItem(`${storeName}_${key}`, JSON.stringify(data));
                console.log('Found in Firebase:', data);
                return data;
            }
        } catch (error) {
            console.warn('Firebase get failed, using localStorage:', error);
        }
    }
    
    // Fallback to localStorage
    const item = localStorage.getItem(`${storeName}_${key}`);
    const result = item ? JSON.parse(item) : null;
    console.log('Found in localStorage:', result);
    return result;
}

async function dbGetAll(storeName) {
    console.log('Getting all from', storeName);
    const results = [];
    
    if (firebaseInitialized && db) {
        try {
            const snapshot = await db.collection(storeName).get();
            snapshot.forEach(doc => {
                const data = doc.data();
                data.id = doc.id; // Store the document ID
                results.push(data);
                localStorage.setItem(`${storeName}_${doc.id}`, JSON.stringify(data));
            });
            console.log('Found in Firebase:', results.length, 'items');
            return results;
        } catch (error) {
            console.warn('Firebase getAll failed, using localStorage:', error);
        }
    }
    
    // Improved localStorage fallback
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(storeName + '_')) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                // Extract ID from key (everything after storeName_)
                const id = key.substring(storeName.length + 1);
                data.id = id; // Ensure ID is set
                results.push(data);
            } catch (e) {
                console.warn('Error parsing localStorage item:', key, e);
            }
        }
    }
    console.log('Found in localStorage:', results.length, 'items for', storeName);
    return results;
}

async function dbDelete(storeName, key) {
    console.log('Deleting from', storeName, 'with key:', key);
    
    if (firebaseInitialized && db) {
        try {
            await db.collection(storeName).doc(key).delete();
        } catch (error) {
            console.warn('Firebase delete failed:', error);
        }
    }
    
    // Always remove from localStorage
    localStorage.removeItem(`${storeName}_${key}`);
}

// Compatible functions
async function idbPut(storeName, obj) {
    const key = obj.lrn || obj.email || obj.id || Math.random().toString(36).substr(2, 9);
    return await dbSave(storeName, key, obj);
}

async function idbGet(storeName, key) {
    return await dbGet(storeName, key);
}

async function idbGetAll(storeName) {
    return await dbGetAll(storeName);
}

async function idbDelete(storeName, key) {
    return await dbDelete(storeName, key);
}

/* ===========================
   Enhanced Account Management
   =========================== */
async function showAllAccounts() {
    console.log('Loading all accounts...');
    showNotification('👥 Loading all accounts...', 'info');
    
    try {
        await renderAccountManagement();
        showNotification('✅ All accounts loaded successfully!', 'success');
        logActivity('Admin viewed all accounts');
    } catch (error) {
        console.error('Error loading accounts:', error);
        showNotification('❌ Error loading accounts: ' + error.message, 'error');
    }
}

async function renderAccountManagement() {
    console.log('Rendering account management...');
    
    try {
        // Get all accounts
        const [teachers, studentAccounts, admins] = await Promise.all([
            idbGetAll(STORE_TEACHERS),
            idbGetAll(STORE_STUDENT_ACCOUNTS),
            idbGetAll(STORE_ADMINS)
        ]);

        // Render Teacher Accounts
        const teacherList = document.getElementById('teacherAccountsList');
        if (teachers.length > 0) {
            let html = '';
            teachers.forEach(teacher => {
                const email = teacher.email || teacher.id;
                const grade = teacher.assignedGrade || 'Not assigned';
                html += `
                    <div class="account-card">
                        <div class="account-header">
                            <strong>${escapeHtml(email)}</strong>
                            <div class="account-actions">
                                <button class="btn-outline admin-btn-small" onclick="editTeacherAccount('${email}')">Edit</button>
                                <button class="btn-danger admin-btn-small" onclick="deleteAccount('teacher','${email}')">Delete</button>
                            </div>
                        </div>
                        <div class="account-details">
                            <div><strong>Role:</strong> Teacher</div>
                            <div><strong>Grade:</strong> ${grade}</div>
                            <div><strong>Created:</strong> ${teacher.createdAt || 'Unknown'}</div>
                        </div>
                    </div>
                `;
            });
            teacherList.innerHTML = html;
        } else {
            teacherList.innerHTML = '<p>No teacher accounts found.</p>';
        }

        // Render Student Accounts
        const studentList = document.getElementById('studentAccountsList');
        if (studentAccounts.length > 0) {
            let html = '';
            studentAccounts.forEach(async (studentAccount) => {
                const lrn = studentAccount.lrn || studentAccount.id;
                // Get student details
                const studentDetails = await idbGet(STORE_STUDENTS, lrn);
                const studentName = studentDetails ? studentDetails.name || `${studentDetails.firstName} ${studentDetails.lastName}` : 'Unknown Student';
                const gradeLevel = studentDetails ? studentDetails.gradeLevel : 'Unknown';
                
                html += `
                    <div class="account-card">
                        <div class="account-header">
                            <strong>${escapeHtml(studentName)}</strong>
                            <div class="account-actions">
                                <button class="btn-danger admin-btn-small" onclick="deleteAccount('student','${lrn}')">Delete</button>
                            </div>
                        </div>
                        <div class="account-details">
                            <div><strong>LRN:</strong> ${lrn}</div>
                            <div><strong>Grade:</strong> ${gradeLevel}</div>
                            <div><strong>Created:</strong> ${studentAccount.createdAt || 'Unknown'}</div>
                        </div>
                    </div>
                `;
            });
            studentList.innerHTML = html;
        } else {
            studentList.innerHTML = '<p>No student accounts found.</p>';
        }

        // Render Admin Accounts
        const adminList = document.getElementById('adminAccountsList');
        if (admins.length > 0) {
            let html = '';
            admins.forEach(admin => {
                const email = admin.email || admin.id;
                html += `
                    <div class="account-card">
                        <div class="account-header">
                            <strong>${escapeHtml(email)}</strong>
                            <div class="account-actions">
                                <button class="btn-danger admin-btn-small" onclick="deleteAccount('admin','${email}')">Delete</button>
                            </div>
                        </div>
                        <div class="account-details">
                            <div><strong>Role:</strong> Administrator</div>
                            <div><strong>Created:</strong> ${admin.createdAt || 'Unknown'}</div>
                        </div>
                    </div>
                `;
            });
            adminList.innerHTML = html;
        } else {
            adminList.innerHTML = '<p>No admin accounts found.</p>';
        }

    } catch (error) {
        console.error('Error rendering account management:', error);
        document.getElementById('teacherAccountsList').innerHTML = 'Error loading accounts';
        document.getElementById('studentAccountsList').innerHTML = 'Error loading accounts';
        document.getElementById('adminAccountsList').innerHTML = 'Error loading accounts';
    }
}

/* ===========================
   Enhanced Printing Functionality
   =========================== */
function printStudentReport() {
    const studentResult = document.getElementById('studentResult');
    if (!studentResult.innerHTML.trim()) {
        showNotification('❌ No report card data to print', 'error');
        return;
    }

    // Create printable content
    const printableContent = document.getElementById('printableReportCard');
    printableContent.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                <h1 style="margin: 0; color: #2b6cb0;">PCCAES - OFFICIAL REPORT CARD</h1>
                <p style="margin: 5px 0; font-size: 14px;">School Year: ${new Date().getFullYear()}-${new Date().getFullYear() + 1}</p>
            </div>
            ${studentResult.innerHTML}
            <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                <p>Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                <p>EZ Grade Tracker System - PCCAES</p>
            </div>
        </div>
    `;

    // Show printable content and trigger print
    printableContent.style.display = 'block';
    window.print();
    printableContent.style.display = 'none';
    
    showNotification('🖨️ Report card sent to printer!', 'success');
    logActivity('Printed student report card');
}

function printView() {
    const viewContent = document.getElementById('viewContent');
    const printableContent = document.getElementById('printableReportCard');
    
    printableContent.innerHTML = `
        <div style="padding: 20px; font-family: Arial, sans-serif;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                <h1 style="margin: 0; color: #2b6cb0;">PCCAES - OFFICIAL DOCUMENT</h1>
                <p style="margin: 5px 0; font-size: 14px;">Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            ${viewContent.innerHTML}
        </div>
    `;

    printableContent.style.display = 'block';
    window.print();
    printableContent.style.display = 'none';
    
    showNotification('🖨️ Document sent to printer!', 'success');
}

/* ===========================
   Security: Hide User Accounts After Login
   =========================== */
function hideUserAccounts() {
    // Hide the create student account section after login
    const createAccountSection = document.querySelector('.login-box hr').nextElementSibling;
    if (createAccountSection) {
        createAccountSection.style.display = 'none';
    }
    
    // Update header to show user info instead of login form
    document.getElementById('headerSubtitle').textContent = `Logged in as ${currentUser.type}`;
    document.getElementById('userInfo').style.display = 'flex';
    
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    
    if (currentUser.type === 'student') {
        userAvatar.textContent = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'S';
        userName.textContent = currentUser.name || `Student (${currentUser.lrn})`;
    } else {
        userAvatar.textContent = currentUser.email ? currentUser.email.charAt(0).toUpperCase() : 'U';
        userName.textContent = currentUser.email || currentUser.type;
    }
}

function showUserAccounts() {
    // Show the create student account section
    const createAccountSection = document.querySelector('.login-box hr').nextElementSibling;
    if (createAccountSection) {
        createAccountSection.style.display = 'block';
    }
    
    // Reset header
    document.getElementById('headerSubtitle').textContent = 'LOGIN FORM';
    document.getElementById('userInfo').style.display = 'none';
}

/* ===========================
   Role Change Handler
   =========================== */
function onRoleChange() {
    const role = document.getElementById('roleSelect').value;
    const studentBlock = document.getElementById('studentLoginBlock');
    const emailBlock = document.getElementById('emailLoginBlock');
    
    if (role === 'student') {
        studentBlock.style.display = 'block';
        emailBlock.style.display = 'none';
    } else {
        studentBlock.style.display = 'none';
        emailBlock.style.display = 'block';
    }
}

/* ===========================
   Login Handler - FIXED
   =========================== */
async function handleLogin() {
    const role = document.getElementById('roleSelect').value;
    const loginMessage = document.getElementById('loginMessage');
    
    loginMessage.style.display = 'none';
    
    try {
        if (role === 'student') {
            // Student login
            const lrn = document.getElementById('studentLoginLRN').value.trim();
            const password = document.getElementById('studentLoginPass').value;
            
            if (!lrn || !password) {
                showLoginMessage('Please enter LRN and password', 'error');
                return;
            }
            
            if (lrn.length !== 12) {
                showLoginMessage('LRN must be 12 digits', 'error');
                return;
            }
            
            // Check student account
            const studentAccount = await idbGet(STORE_STUDENT_ACCOUNTS, lrn);
            console.log('Student account found:', studentAccount);
            
            if (!studentAccount) {
                showLoginMessage('No student account found with this LRN', 'error');
                return;
            }
            
            if (studentAccount.password !== password) {
                showLoginMessage('Invalid password', 'error');
                return;
            }
            
            // Check if student record exists
            const studentRecord = await idbGet(STORE_STUDENTS, lrn);
            console.log('Student record found:', studentRecord);
            
            if (!studentRecord) {
                showLoginMessage('Student record not found. Please contact administrator.', 'error');
                return;
            }
            
            currentUser = {
                type: 'student',
                lrn: lrn,
                name: studentRecord.name || `${studentRecord.firstName} ${studentRecord.lastName}`
            };
            
            showLoginMessage('Login successful!', 'success');
            showNotification('🎉 Student login successful! Welcome back!', 'success');
            logActivity(`Student ${lrn} logged in successfully`);
            hideUserAccounts();
            setTimeout(() => navigateTo('student'), 1000);
            
        } else {
            // Admin/Teacher login
            const email = document.getElementById('emailLogin').value.trim().toLowerCase();
            const password = document.getElementById('emailLoginPass').value;
            
            if (!email || !password) {
                showLoginMessage('Please enter email and password', 'error');
                return;
            }
            
            if (role === 'admin') {
                // Check admin account
                const admin = await idbGet(STORE_ADMINS, email);
                if (!admin || admin.password !== password) {
                    showLoginMessage('Invalid email or password', 'error');
                    return;
                }
                
                currentUser = {
                    type: 'admin',
                    email: email
                };
                
                showLoginMessage('Admin login successful!', 'success');
                showNotification('🔐 Admin login successful! Welcome to the dashboard!', 'success');
                logActivity(`Admin ${email} logged in successfully`);
                hideUserAccounts();
                setTimeout(() => navigateTo('admin'), 1000);
                
            } else {
                // Teacher login (including grade-specific teachers)
                const teacher = await idbGet(STORE_TEACHERS, email);
                if (!teacher || teacher.password !== password) {
                    showLoginMessage('Invalid email or password', 'error');
                    return;
                }
                
                currentUser = {
                    type: 'teacher',
                    email: email,
                    assignedGrade: teacher.assignedGrade
                };
                
                showLoginMessage('Teacher login successful!', 'success');
                showNotification('👨‍🏫 Teacher login successful! Welcome to your dashboard!', 'success');
                logActivity(`Teacher ${email} (Grade ${teacher.assignedGrade}) logged in successfully`);
                hideUserAccounts();
                setTimeout(() => navigateTo('teacher'), 1000);
            }
        }
    } catch (error) {
        console.error('Login error:', error);
        showLoginMessage('Login failed: ' + error.message, 'error');
        showNotification('❌ Login failed: ' + error.message, 'error');
    }
}

function showLoginMessage(message, type) {
    const loginMessage = document.getElementById('loginMessage');
    loginMessage.textContent = message;
    loginMessage.className = `login-message login-${type}`;
    loginMessage.style.display = 'block';
}

/* ===========================
   Create Student Account - FIXED
   =========================== */
async function handleCreateStudentAccount() {
    const lrn = document.getElementById('createLRN').value.trim();
    const password = document.getElementById('createPass').value;
    const confirmPassword = document.getElementById('createPass2').value;
    
    if (!lrn || !password) {
        showNotification('❌ Please enter LRN and password', 'error');
        return;
    }
    
    if (lrn.length !== 12) {
        showNotification('❌ LRN must be exactly 12 digits', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('❌ Passwords do not match', 'error');
        return;
    }
    
    try {
        // Check if student record exists
        const studentRecord = await idbGet(STORE_STUDENTS, lrn);
        if (!studentRecord) {
            showNotification('❌ LRN not found in student records. Please contact your teacher to add your record first.', 'error');
            return;
        }
        
        // Check if account already exists
        const existingAccount = await idbGet(STORE_STUDENT_ACCOUNTS, lrn);
        if (existingAccount) {
            showNotification('❌ Student account already exists for this LRN', 'error');
            return;
        }
        
        // Create account
        await idbPut(STORE_STUDENT_ACCOUNTS, {
            lrn: lrn,
            password: password,
            createdAt: new Date().toLocaleDateString()
        });
        
        const studentName = studentRecord.name || `${studentRecord.firstName} ${studentRecord.lastName}`;
        showNotification(`🎉 Student account created successfully for ${studentName} (LRN: ${lrn})! You can now login.`, 'success');
        logActivity(`Student account created for ${studentName} (LRN: ${lrn})`);
        clearCreateForm();
        
    } catch (error) {
        console.error('Error creating student account:', error);
        showNotification('❌ Error creating account: ' + error.message, 'error');
    }
}

function clearCreateForm() {
    document.getElementById('createLRN').value = '';
    document.getElementById('createPass').value = '';
    document.getElementById('createPass2').value = '';
}

/* ===========================
   Student Dashboard Functions
   =========================== */
async function studentSearch() {
    const searchLRN = document.getElementById('studentSearchLRN').value.trim();
    const lrnToSearch = searchLRN || (currentUser ? currentUser.lrn : '');
    
    if (!lrnToSearch) {
        showNotification('❌ Please enter an LRN to search', 'error');
        return;
    }
    
    try {
        const student = await idbGet(STORE_STUDENTS, lrnToSearch);
        if (!student) {
            showNotification('❌ Student record not found', 'error');
            return;
        }
        
        displayStudentReportCard(student);
        showNotification(`📊 Report card loaded for ${student.name || student.firstName}`, 'success');
        logActivity(`Viewed report card for ${student.name || student.firstName} (LRN: ${lrnToSearch})`);
        
    } catch (error) {
        console.error('Error searching student:', error);
        showNotification('❌ Error loading student data', 'error');
    }
}

function displayStudentReportCard(student) {
    const studentResult = document.getElementById('studentResult');
    const grades = student.grades || {};
    
    let html = `
        <div style="background:white;padding:20px;border-radius:8px;border:1px solid #e8eef8;">
            <h3 style="margin-top:0;">Student Information</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                <div><strong>Name:</strong> ${escapeHtml(student.name || `${student.lastName}, ${student.firstName}`)}</div>
                <div><strong>LRN:</strong> ${escapeHtml(student.lrn)}</div>
                <div><strong>Grade Level:</strong> ${escapeHtml(student.gradeLevel)}</div>
                <div><strong>Section:</strong> ${escapeHtml(student.section || 'N/A')}</div>
                <div><strong>School Year:</strong> ${escapeHtml(student.schoolYear || 'N/A')}</div>
                <div><strong>Adviser:</strong> ${escapeHtml(student.adviser || 'N/A')}</div>
            </div>
            
            <h3>Grades</h3>
            <table class="table print-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>1st Quarter</th>
                        <th>2nd Quarter</th>
                        <th>3rd Quarter</th>
                        <th>4th Quarter</th>
                        <th>Final Grade</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const subjects = Object.keys(grades);
    let totalFinal = 0;
    let subjectCount = 0;
    
    subjects.forEach(subject => {
        const subjectGrades = grades[subject];
        const q1 = subjectGrades.q1 || '-';
        const q2 = subjectGrades.q2 || '-';
        const q3 = subjectGrades.q3 || '-';
        const q4 = subjectGrades.q4 || '-';
        
        // Calculate final grade (average of all quarters)
        const quarters = [q1, q2, q3, q4].filter(grade => grade !== '-');
        const finalGrade = quarters.length > 0 ? 
            (quarters.reduce((sum, grade) => sum + grade, 0) / quarters.length).toFixed(2) : '-';
        
        if (finalGrade !== '-') {
            totalFinal += parseFloat(finalGrade);
            subjectCount++;
        }
        
        html += `
            <tr>
                <td style="text-align:left">${subject}</td>
                <td>${q1}</td>
                <td>${q2}</td>
                <td>${q3}</td>
                <td>${q4}</td>
                <td><strong>${finalGrade}</strong></td>
            </tr>
        `;
    });
    
    const overallAverage = subjectCount > 0 ? (totalFinal / subjectCount).toFixed(2) : '-';
    
    html += `
                </tbody>
                <tfoot>
                    <tr style="background:#eef6ff;">
                        <td colspan="5" style="text-align:right"><strong>Overall Average:</strong></td>
                        <td><strong>${overallAverage}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    studentResult.innerHTML = html;
    document.getElementById('btnStudentPrint').style.display = 'inline-block';
}

/* ===========================
   Admin Account Creation - FIXED
   =========================== */
async function adminCreateAccount() {
    console.log('Admin creating account...');
    
    const email = document.getElementById('adminCreateEmail').value.trim().toLowerCase();
    const password = document.getElementById('adminCreatePass').value;
    const role = document.getElementById('adminCreateRole').value;
    const grade = document.getElementById('adminCreateGrade').value;
    
    console.log('Form data:', { email, password, role, grade });
    
    // Validation
    if (!email || !password) {
        showAdminFeedback('❌ Please enter email and password', 'error');
        return;
    }
    
    if (role === 'teacher' && !grade) {
        showAdminFeedback('❌ Please select a grade level for teacher accounts', 'error');
        return;
    }
    
    try {
        let accountData;
        let storeName;
        
        if (role === 'teacher') {
            storeName = STORE_TEACHERS;
            // Check if teacher already exists
            const existingTeacher = await idbGet(storeName, email);
            if (existingTeacher) {
                showAdminFeedback('❌ Teacher account already exists with this email', 'error');
                return;
            }
            
            accountData = { 
                email: email, 
                password: password, 
                role: 'teacher', 
                assignedGrade: grade,
                createdAt: new Date().toLocaleDateString()
            };
            
        } else if (role === 'admin') {
            storeName = STORE_ADMINS;
            // Check if admin already exists
            const existingAdmin = await idbGet(storeName, email);
            if (existingAdmin) {
                showAdminFeedback('❌ Admin account already exists with this email', 'error');
                return;
            }
            
            accountData = { 
                email: email, 
                password: password,
                createdAt: new Date().toLocaleDateString()
            };
        }
        
        console.log('Saving account to', storeName, ':', accountData);
        await idbPut(storeName, accountData);
        
        const successMessage = `${role.charAt(0).toUpperCase() + role.slice(1)} account created successfully for ${email}${role === 'teacher' ? ` (Grade ${grade})` : ''}!`;
        showAdminFeedback(successMessage, 'success');
        showNotification(`✅ ${successMessage}`, 'success');
        logActivity(`Created ${role} account for ${email}${role === 'teacher' ? ` (Grade ${grade})` : ''}`);
        
        // Clear form
        document.getElementById('adminCreateEmail').value = '';
        document.getElementById('adminCreatePass').value = '';
        document.getElementById('adminCreateGrade').value = '';
        
        // Refresh accounts list immediately
        await renderAccountManagement();
        
    } catch (error) {
        console.error('Error creating account:', error);
        showAdminFeedback('❌ Error creating account: ' + error.message, 'error');
        showNotification('❌ Error creating account: ' + error.message, 'error');
    }
}

function showAdminFeedback(message, type) {
    const feedbackEl = document.getElementById('adminCreateFeedback');
    feedbackEl.textContent = message;
    feedbackEl.className = `feedback ${type}`;
    feedbackEl.style.display = 'block';
    
    // Auto-hide success messages
    if (type === 'success') {
        setTimeout(() => {
            feedbackEl.style.display = 'none';
        }, 5000);
    }
}

/* ===========================
   Enhanced Account Management Functions
   =========================== */
async function deleteAccount(type, identifier) {
    if (!confirm(`Are you sure you want to delete this ${type} account? This action cannot be undone.`)) {
        return;
    }
    
    try {
        let storeName;
        if (type === 'admin') {
            storeName = STORE_ADMINS;
        } else if (type === 'teacher') {
            storeName = STORE_TEACHERS;
        } else if (type === 'student') {
            storeName = STORE_STUDENT_ACCOUNTS;
        }
        
        console.log(`Deleting ${type} account:`, identifier, 'from store:', storeName);
        await idbDelete(storeName, identifier);
        
        const successMessage = `${type} account deleted successfully!`;
        showAdminFeedback(successMessage, 'success');
        showNotification(`🗑️ ${successMessage}`, 'success');
        logActivity(`Deleted ${type} account: ${identifier}`);
        
        // Refresh the accounts list
        await renderAccountManagement();
        
    } catch (error) {
        console.error('Error deleting account:', error);
        showAdminFeedback('❌ Error deleting account: ' + error.message, 'error');
        showNotification('❌ Error deleting account: ' + error.message, 'error');
    }
}

async function editTeacherAccount(email) {
    try {
        const teacher = await idbGet(STORE_TEACHERS, email);
        if (!teacher) {
            showNotification('❌ Teacher account not found', 'error');
            return;
        }
        
        const newGrade = prompt(`Edit assigned grade for ${email}:`, teacher.assignedGrade || '');
        if (newGrade === null) return; // User cancelled
        
        if (newGrade.trim() === '') {
            showNotification('❌ Grade cannot be empty', 'error');
            return;
        }
        
        teacher.assignedGrade = newGrade.trim();
        await idbPut(STORE_TEACHERS, teacher);
        
        showNotification(`✅ Teacher ${email} updated to Grade ${newGrade}`, 'success');
        logActivity(`Updated teacher ${email} to Grade ${newGrade}`);
        
        // Refresh accounts list
        await renderAccountManagement();
        
    } catch (error) {
        console.error('Error updating teacher account:', error);
        showNotification('❌ Error updating teacher account: ' + error.message, 'error');
    }
}

/* ===========================
   Teacher Dashboard Functions
   =========================== */
function updateTeacherDashboard() {
    if (currentUser && currentUser.type === 'teacher') {
        document.getElementById('teacherWelcomeName').textContent = currentUser.email;
        document.getElementById('teacherAssignedGrade').textContent = 
            currentUser.assignedGrade === 'sped' ? 'SPED' : 
            currentUser.assignedGrade === 'kinder' ? 'Kinder' : 
            `Grade ${currentUser.assignedGrade}`;
        
        // Highlight the assigned grade button
        const gradeButtons = ['sped', 'kinder', '1', '2', '3', '4', '5', '6'];
        gradeButtons.forEach(grade => {
            const btn = document.getElementById(`gradeBtn${grade === 'sped' ? 'Sped' : grade === 'kinder' ? 'Kinder' : grade}`);
            if (btn) {
                if (grade === currentUser.assignedGrade) {
                    btn.className = 'btn-primary';
                } else {
                    btn.className = 'btn-outline';
                    btn.disabled = true;
                }
            }
        });
    }
}

function openAssignedGradeDashboard(grade) {
    if (currentUser && currentUser.type === 'teacher' && currentUser.assignedGrade === grade) {
        openGradeDashboard(grade);
    } else {
        alert('You are not assigned to this grade level.');
    }
}

function openGradeDashboard(grade) {
    currentGradeContext = grade;
    const gradeTitle = document.getElementById('gradeTitle');
    
    const gradeLabel = grade === 'sped' ? 'SPED' : 
                     grade === 'kinder' ? 'Kinder' : 
                     `Grade ${grade}`;
    
    gradeTitle.textContent = `${gradeLabel} Dashboard`;
    
    // Show back button for teachers
    const backBtn = document.getElementById('backToTeacherBtn');
    if (currentUser && currentUser.type === 'teacher') {
        backBtn.style.display = 'inline-block';
    } else {
        backBtn.style.display = 'none';
    }
    
    navigateTo('grade');
    renderGradeTable();
    logActivity(`Opened ${gradeLabel} dashboard`);
}

function goBackToTeacher() {
    if (currentUser && currentUser.type === 'teacher') {
        navigateTo('teacher');
        logActivity('Returned to teacher dashboard');
    }
}

/* ===========================
   Add/Edit Student Modal Functions - FIXED LRN UPDATE
   =========================== */
function openAddStudentModal() {
    document.getElementById('studentModalTitle').textContent = 'Add Student';
    document.getElementById('edit_lrn_key').value = '';
    
    // Reset form
    document.getElementById('studentForm').reset();
    
    // Set default grade level based on current context
    if (currentGradeContext) {
        document.getElementById('f_grade').value = currentGradeContext;
    }
    
    // Set current user as adviser if teacher
    if (currentUser && currentUser.type === 'teacher') {
        document.getElementById('f_adviser').value = currentUser.email;
    }
    
    // Set current school year
    const currentYear = new Date().getFullYear();
    document.getElementById('f_schoolyear').value = `${currentYear}-${currentYear + 1}`;
    
    // Populate subjects
    populateGradeInputs();
    
    // Show modal
    document.getElementById('studentModal').style.display = 'flex';
}

function populateGradeInputs() {
    const grade = document.getElementById('f_grade').value;
    const subjects = getSubjectsForGrade(grade);
    const gradesInputsBody = document.getElementById('gradesInputsBody');
    
    let html = '';
    subjects.forEach(subject => {
        html += `
            <tr>
                <td>${subject}</td>
                <td><input type="number" min="0" max="100" step="0.01" id="grade_${subject}_q1" placeholder="Q1"></td>
                <td><input type="number" min="0" max="100" step="0.01" id="grade_${subject}_q2" placeholder="Q2"></td>
                <td><input type="number" min="0" max="100" step="0.01" id="grade_${subject}_q3" placeholder="Q3"></td>
                <td><input type="number" min="0" max="100" step="0.01" id="grade_${subject}_q4" placeholder="Q4"></td>
            </tr>
        `;
    });
    
    gradesInputsBody.innerHTML = html;
}

async function handleStudentFormSubmit(event) {
    event.preventDefault();
    
    const lrn = document.getElementById('f_lrn').value.trim();
    const lastName = document.getElementById('f_last').value.trim();
    const firstName = document.getElementById('f_first').value.trim();
    const middleName = document.getElementById('f_middle').value.trim();
    const gender = document.getElementById('f_gender').value;
    const gradeLevel = document.getElementById('f_grade').value;
    const section = document.getElementById('f_section').value.trim();
    const schoolYear = document.getElementById('f_schoolyear').value.trim();
    const adviser = document.getElementById('f_adviser').value.trim();
    
    // Validation
    if (!lrn || lrn.length !== 12) {
        showNotification('❌ Please enter a valid 12-digit LRN', 'error');
        return;
    }
    
    if (!lastName || !firstName) {
        showNotification('❌ Please enter at least last name and first name', 'error');
        return;
    }
    
    // Check if LRN already exists to determine if this is an update
    const existingStudent = await idbGet(STORE_STUDENTS, lrn);
    const isEdit = document.getElementById('edit_lrn_key').value;
    
    // If we're in edit mode but LRN changed, check if new LRN already exists
    if (isEdit && isEdit !== lrn) {
        const studentWithNewLRN = await idbGet(STORE_STUDENTS, lrn);
        if (studentWithNewLRN) {
            showNotification('❌ A student with this LRN already exists', 'error');
            return;
        }
    }
    
    // If we're adding a new student and LRN already exists, update instead
    if (!isEdit && existingStudent) {
        // Ask user if they want to update existing student
        if (!confirm(`A student with LRN ${lrn} already exists. Do you want to update the existing record?`)) {
            return;
        }
        // Proceed with update
    }
    
    // Collect grades
    const grades = {};
    const subjects = getSubjectsForGrade(gradeLevel);
    
    subjects.forEach(subject => {
        const q1 = document.getElementById(`grade_${subject}_q1`).value;
        const q2 = document.getElementById(`grade_${subject}_q2`).value;
        const q3 = document.getElementById(`grade_${subject}_q3`).value;
        const q4 = document.getElementById(`grade_${subject}_q4`).value;
        
        grades[subject] = {
            q1: q1 ? parseFloat(q1) : null,
            q2: q2 ? parseFloat(q2) : null,
            q3: q3 ? parseFloat(q3) : null,
            q4: q4 ? parseFloat(q4) : null
        };
    });
    
    // Create student object
    const studentData = {
        lrn: lrn,
        lastName: lastName,
        firstName: firstName,
        middleName: middleName,
        name: `${lastName}, ${firstName}`,
        gender: gender,
        gradeLevel: gradeLevel,
        section: section,
        schoolYear: schoolYear,
        adviser: adviser,
        grades: grades
    };
    
    try {
        // Save student - this will update if LRN already exists
        await idbPut(STORE_STUDENTS, studentData);
        
        // Close modal
        closeModal('studentModal');
        
        // Refresh table
        renderGradeTable();
        
        // Show success notification
        const action = (isEdit || existingStudent) ? 'updated' : 'added';
        const studentName = `${lastName}, ${firstName}`;
        showNotification(`✅ Student ${studentName} ${action} successfully!`, 'success');
        logActivity(`${action.charAt(0).toUpperCase() + action.slice(1)} student: ${studentName} (LRN: ${lrn}, Grade: ${gradeLevel})`);
        
    } catch (error) {
        console.error('Error saving student:', error);
        showNotification('❌ Error saving student: ' + error.message, 'error');
    }
}

async function editStudent(lrn) {
    try {
        const student = await idbGet(STORE_STUDENTS, lrn);
        if (!student) {
            showNotification('❌ Student not found', 'error');
            return;
        }
        
        document.getElementById('studentModalTitle').textContent = 'Edit Student';
        document.getElementById('edit_lrn_key').value = lrn;
        
        // Fill form with student data
        document.getElementById('f_lrn').value = student.lrn;
        document.getElementById('f_last').value = student.lastName || '';
        document.getElementById('f_first').value = student.firstName || '';
        document.getElementById('f_middle').value = student.middleName || '';
        document.getElementById('f_gender').value = student.gender || '';
        document.getElementById('f_grade').value = student.gradeLevel || '';
        document.getElementById('f_section').value = student.section || '';
        document.getElementById('f_schoolyear').value = student.schoolYear || '';
        document.getElementById('f_adviser').value = student.adviser || '';
        
        // Populate subjects and grades
        populateGradeInputs();
        
        // Fill grades
        if (student.grades) {
            Object.keys(student.grades).forEach(subject => {
                const subjectGrades = student.grades[subject];
                if (subjectGrades.q1) document.getElementById(`grade_${subject}_q1`).value = subjectGrades.q1;
                if (subjectGrades.q2) document.getElementById(`grade_${subject}_q2`).value = subjectGrades.q2;
                if (subjectGrades.q3) document.getElementById(`grade_${subject}_q3`).value = subjectGrades.q3;
                if (subjectGrades.q4) document.getElementById(`grade_${subject}_q4`).value = subjectGrades.q4;
            });
        }
        
        // Show modal
        document.getElementById('studentModal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error loading student for edit:', error);
        showNotification('❌ Error loading student data', 'error');
    }
}

async function deleteStudent(lrn) {
    if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
        return;
    }
    
    try {
        // Get student info before deletion for logging
        const student = await idbGet(STORE_STUDENTS, lrn);
        const studentName = student ? student.name || `${student.firstName} ${student.lastName}` : lrn;
        
        // Delete student record
        await idbDelete(STORE_STUDENTS, lrn);
        
        // Also delete student account if exists
        await idbDelete(STORE_STUDENT_ACCOUNTS, lrn);
        
        // Refresh table
        renderGradeTable();
        
        // Show notification
        showNotification(`🗑️ Student ${studentName} deleted successfully!`, 'success');
        logActivity(`Deleted student: ${studentName} (LRN: ${lrn})`);
        
    } catch (error) {
        console.error('Error deleting student:', error);
        showNotification('❌ Error deleting student: ' + error.message, 'error');
    }
}

/* ===========================
   Grade Table Rendering
   =========================== */
async function renderGradeTable() {
    if (!currentGradeContext) return;
    
    const tableBody = document.getElementById('gradeTableBody');
    tableBody.innerHTML = '<tr><td colspan="13">Loading...</td></tr>';
    
    try {
        const allStudents = await idbGetAll(STORE_STUDENTS);
        const lrnFilter = document.getElementById('gradeFilterLRN').value.toLowerCase();
        const sectionFilter = document.getElementById('gradeFilterSection').value.toLowerCase();
        
        // Filter students by grade and optional filters
        const gradeStudents = allStudents.filter(student => {
            if (String(student.gradeLevel) !== String(currentGradeContext)) return false;
            if (lrnFilter && !student.lrn.toLowerCase().includes(lrnFilter)) return false;
            if (sectionFilter && !(student.section || '').toLowerCase().includes(sectionFilter)) return false;
            return true;
        });
        
        if (gradeStudents.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="13">No students found</td></tr>';
            return;
        }
        
        let html = '';
        gradeStudents.forEach((student, index) => {
            const grades = student.grades || {};
            const q1Avg = calculateQuarterAverage(grades, 'q1');
            const q2Avg = calculateQuarterAverage(grades, 'q2');
            const q3Avg = calculateQuarterAverage(grades, 'q3');
            const q4Avg = calculateQuarterAverage(grades, 'q4');
            const overallAvg = calculateOverallAverage(grades);
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${escapeHtml(student.name || `${student.lastName}, ${student.firstName}`)}</td>
                    <td>${escapeHtml(student.lrn)}</td>
                    <td>${escapeHtml(student.gradeLevel)}</td>
                    <td>${escapeHtml(student.section || '')}</td>
                    <td>${escapeHtml(student.schoolYear || '')}</td>
                    <td>${escapeHtml(student.adviser || '')}</td>
                    <td>${formatGrade(q1Avg)}</td>
                    <td>${formatGrade(q2Avg)}</td>
                    <td>${formatGrade(q3Avg)}</td>
                    <td>${formatGrade(q4Avg)}</td>
                    <td>${formatGrade(overallAvg)}</td>
                    <td>
                        <button class="btn-outline admin-btn-small" onclick="editStudent('${student.lrn}')">Edit</button>
                        <button class="btn-danger admin-btn-small" onclick="deleteStudent('${student.lrn}')">Delete</button>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('Error rendering grade table:', error);
        tableBody.innerHTML = '<tr><td colspan="13">Error loading students</td></tr>';
    }
}

function formatGrade(grade) {
    if (grade === null || grade === undefined) return '-';
    return Number(grade).toFixed(decimalPlaces);
}

function calculateQuarterAverage(grades, quarter) {
    const quarterGrades = Object.values(grades)
        .map(subject => subject[quarter])
        .filter(grade => grade !== undefined && grade !== null && grade !== '');
    
    if (quarterGrades.length === 0) return null;
    
    const sum = quarterGrades.reduce((a, b) => a + b, 0);
    return sum / quarterGrades.length;
}

function calculateOverallAverage(grades) {
    const allGrades = [];
    ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
        const quarterGrades = Object.values(grades)
            .map(subject => subject[quarter])
            .filter(grade => grade !== undefined && grade !== null && grade !== '');
        allGrades.push(...quarterGrades);
    });
    
    if (allGrades.length === 0) return null;
    
    const sum = allGrades.reduce((a, b) => a + b, 0);
    return sum / allGrades.length;
}

function changeDecimal(delta) {
    decimalPlaces = Math.max(0, Math.min(5, decimalPlaces + delta));
    document.getElementById('decimalDisplay').textContent = decimalPlaces;
    renderGradeTable();
    showNotification(`🔢 Decimal places set to ${decimalPlaces}`, 'info');
    logActivity(`Changed decimal places to ${decimalPlaces}`);
}

/* ===========================
   Subject lists
   =========================== */
const SUBJECTS_MAP = {
  'kinder': ['Filipino','English','Mathematics','Science','AP','TLE','ESP','GMRC'],
  'sped': ['Filipino','English','Mathematics','Science','AP','TLE','ESP','GMRC'],
  '1': ['Reading & Literacy','Language','Mathematics','Makabansa','GMRC','Arabic Language','Islamic Values Education'],
  '2': ['Reading & Literacy','Language','Mathematics','Makabansa','GMRC','Arabic Language','Islamic Values Education'],
  '3': ['Filipino','English','Mathematics','Science','Araling Panlipunan (AP)','Edukasyong Pantahanan at Pangkabuhayan (EPP)','Music & Arts','PE & Health','GMRC','Arabic Language','Islamic Values Education'],
  '4': ['Filipino','English','Mathematics','Science','Araling Panlipunan (AP)','Edukasyong Pantahanan at Pangkabuhayan (EPP)','Music','Arts','Physical Education (PE)','Health','Arabic Language','Islamic Values Education','GMRC'],
  '5': ['Filipino','English','Mathematics','Science','Araling Panlipunan (AP)','Edukasyong Pantahanan at Pangkabuhayan (EPP)','Music','Arts','Physical Education (PE)','Health','Arabic Language','Islamic Values Education','GMRC'],
  '6': ['Filipino','English','Mathematics','Science','Araling Panlipunan (AP)','Edukasyong Pantahanan at Pangkabuhayan (EPP)','Music','Arts','Physical Education (PE)','Health','Edukasyon sa Pagpapakatao (ESP)','Arabic Language','Islamic Values Education','GMRC']
};

function getSubjectsForGrade(g) {
  return SUBJECTS_MAP[String(g)] || SUBJECTS_MAP['kinder'];
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===========================
   UI State and Navigation
   =========================== */
let currentUser = null;
let currentGradeContext = null;
let decimalPlaces = 2;

function showLanding(){
  document.getElementById('landing').style.display = 'block';
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  currentUser = null;
  currentGradeContext = null;
  showUserAccounts(); // Show accounts when returning to landing
}

function navigateTo(page) {
  console.log('Navigating to:', page);
  document.getElementById('landing').style.display = 'none';
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  
  if (page === 'student') {
      document.getElementById('page-student').classList.add('active');
      // Auto-load current student's data
      if (currentUser && currentUser.type === 'student') {
          setTimeout(() => studentSearch(), 500);
      }
  } else if (page === 'admin') {
      document.getElementById('page-admin').classList.add('active');
      // Auto-refresh accounts list when admin page is opened
      setTimeout(() => renderAccountManagement(), 100);
      // Update current time
      document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
  } else if (page === 'teacher') {
      document.getElementById('page-teacher').classList.add('active');
      updateTeacherDashboard();
      // Update current time
      document.getElementById('teacherCurrentTime').textContent = new Date().toLocaleTimeString();
  } else if (page === 'grade') {
      document.getElementById('page-grade').classList.add('active');
      // Update current time
      document.getElementById('gradeCurrentTime').textContent = new Date().toLocaleTimeString();
  }
}

function logout(){
  if (currentUser) {
      logActivity(`${currentUser.type} ${currentUser.email || currentUser.lrn} logged out`);
  }
  showLanding();
  showNotification('👋 Logged out successfully!', 'info');
}

/* ===========================
   Forgot Password Modal
   =========================== */
function showForgotPasswordModal() {
    alert('Please contact your teacher or administrator to reset your password.');
}

/* ===========================
   Test Function to Verify Accounts
   =========================== */
async function testAccounts() {
    console.log('=== TESTING ACCOUNTS ===');
    
    const admins = await idbGetAll(STORE_ADMINS);
    const teachers = await idbGetAll(STORE_TEACHERS);
    const students = await idbGetAll(STORE_STUDENTS);
    const studentAccounts = await idbGetAll(STORE_STUDENT_ACCOUNTS);
    
    console.log('Admins in database:', admins);
    console.log('Teachers in database:', teachers);
    console.log('Students in database:', students);
    console.log('Student accounts in database:', studentAccounts);
    
    // Test if we can retrieve specific accounts
    const testAdmin = await idbGet(STORE_ADMINS, 'admin@depedqc.ph');
    const testTeacher = await idbGet(STORE_TEACHERS, 'teacher1@depedqc.ph');
    const testStudent = await idbGet(STORE_STUDENTS, '123456789012');
    const testStudentAccount = await idbGet(STORE_STUDENT_ACCOUNTS, '123456789012');
    
    console.log('Test admin retrieval:', testAdmin);
    console.log('Test teacher retrieval:', testTeacher);
    console.log('Test student retrieval:', testStudent);
    console.log('Test student account retrieval:', testStudentAccount);
    
    showNotification('🧪 Account test completed. Check browser console for details.', 'info');
    logActivity('Ran account verification test');
    
    alert(`Accounts Test Results:\n\nAdmins: ${admins.length} accounts\nTeachers: ${teachers.length} accounts\nStudents: ${students.length} records\nStudent Accounts: ${studentAccounts.length} accounts\n\nCheck browser console for details.`);
}

/* ===========================
   Placeholder functions for unimplemented features
   =========================== */
function exportGrade() {
    showNotification('📤 Export feature will be implemented in the next update', 'info');
    logActivity('Attempted to export grade data');
}

function exportAllCSV() {
    showNotification('📤 Export All CSV feature will be implemented in the next update', 'info');
    logActivity('Attempted to export all data as CSV');
}

function purgeAll() {
    if (confirm('Are you sure you want to delete ALL students? This cannot be undone.')) {
        showNotification('🗑️ Purge All feature will be implemented in the next update', 'info');
        logActivity('Attempted to purge all student data');
    }
}

function showAllAccounts() {
    renderAccountManagement();
    showNotification('👥 Accounts list refreshed!', 'info');
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

/* ===========================
   Initialization
   =========================== */
async function initializeApp() {
  initializeFirebase();
  await seedInitialData();
  showLanding();
  logActivity('System initialized successfully');
}

async function seedInitialData() {
  console.log('Seeding initial data...');
  
  // Seed admin if doesn't exist
  const admins = await idbGetAll(STORE_ADMINS);
  if (admins.length === 0) {
      console.log('Creating default admin account...');
      await idbPut(STORE_ADMINS, { 
          email: 'admin@depedqc.ph', 
          password: 'admin123',
          createdAt: new Date().toLocaleDateString()
      });
      logActivity('Default admin account created: admin@depedqc.ph');
  }
  
  // Seed teacher if doesn't exist
  const teacher = await idbGet(STORE_TEACHERS, 'teacher1@depedqc.ph');
  if (!teacher) {
      console.log('Creating default teacher account...');
      await idbPut(STORE_TEACHERS, { 
          email: 'teacher1@depedqc.ph', 
          password: 'teacher123', 
          role: 'teacher', 
          assignedGrade: '1',
          createdAt: new Date().toLocaleDateString()
      });
      logActivity('Default teacher account created: teacher1@depedqc.ph (Grade 1)');
  }
  
  // Seed demo student if doesn't exist
  const student = await idbGet(STORE_STUDENTS, '123456789012');
  if (!student) {
      console.log('Creating demo student...');
      const demoStudent = {
          lrn: '123456789012',
          lastName: 'Dela Cruz',
          firstName: 'Juan',
          middleName: 'Santos',
          name: 'Dela Cruz, Juan',
          gender: 'Male',
          gradeLevel: '1',
          section: 'A',
          schoolYear: '2024-2025',
          adviser: 'Mrs. Teacher',
          grades: {
              'Reading & Literacy': { q1: 85, q2: 87, q3: 88, q4: 86 },
              'Language': { q1: 90, q2: 89, q3: 91, q4: 90 },
              'Mathematics': { q1: 80, q2: 82, q3: 79, q4: 81 }
          }
      };
      await idbPut(STORE_STUDENTS, demoStudent);
      logActivity('Demo student created: Juan Dela Cruz (LRN: 123456789012)');
  }
  
  // Seed demo student account if doesn't exist
  const studentAccount = await idbGet(STORE_STUDENT_ACCOUNTS, '123456789012');
  if (!studentAccount) {
      console.log('Creating demo student account...');
      await idbPut(STORE_STUDENT_ACCOUNTS, { 
          lrn: '123456789012', 
          password: 'student123',
          createdAt: new Date().toLocaleDateString()
      });
      logActivity('Demo student account created for LRN: 123456789012');
  }
  
  console.log('Initial data seeding completed');
}

// Start the application
initializeApp();

// Global exports
window.showLanding = showLanding;
window.openGradeDashboard = openGradeDashboard;
window.openAssignedGradeDashboard = openAssignedGradeDashboard;
window.handleLogin = handleLogin;
window.handleCreateStudentAccount = handleCreateStudentAccount;
window.clearCreateForm = clearCreateForm;
window.logout = logout;
window.goBackToTeacher = goBackToTeacher;
window.onRoleChange = onRoleChange;
window.adminCreateAccount = adminCreateAccount;
window.showAllAccounts = showAllAccounts;
window.renderAccountManagement = renderAccountManagement;
window.deleteAccount = deleteAccount;
window.editTeacherAccount = editTeacherAccount;
window.testAccounts = testAccounts;
window.renderGradeTable = renderGradeTable;
window.changeDecimal = changeDecimal;
window.showForgotPasswordModal = showForgotPasswordModal;
window.openAddStudentModal = openAddStudentModal;
window.editStudent = editStudent;
window.deleteStudent = deleteStudent;
window.handleStudentFormSubmit = handleStudentFormSubmit;
window.closeModal = closeModal;
window.populateGradeInputs = populateGradeInputs;
window.studentSearch = studentSearch;
window.printStudentReport = printStudentReport;
window.printView = printView;
</script>
</body>
</html>